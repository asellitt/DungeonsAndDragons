---
layout: default
title: Encounters
---

<div class="inputs">
  <div>
    <label>Average Party Level</label> <input class="js-level" type="number" placeholder="Average Party Level" min="1" max="20" autofocus="true" />
  </div>
  <div>
    <label>Number of Players</label> <input class="js-players" type="number" placeholder="Number of Players" min="1" max="20" />
  </div>
  <div>
    <label>Boss</label>
    <select class="js-boss">
      <option>None</option>
      <option>Heavy</option>
      <option>Light</option>
      <option>Ranged</option>
      <option>Arcane Caster</option>
      <option>Divine Caster</option>
    </select>
  </div>
</div>

<div id="encounters"></div>

<div id="template" class="encounter">
  <div class="name">
    <span class="js-name"></span>
  </div>
  <div>
    <div class="two-column">
      <div><b>Level</b> <span class="js-level"></span></div>
      <div><b>Armour Class</b> <span class="js-ac"></span></div>
      <div><b>Hit Points</b> <span class="js-hp"></span></div>
    </div>
    <div class="two-column">
      <div class="reroll js-reroll">
        <svg class="dice" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <path stroke="#58170D" d="M80.644,87.982l16.592-41.483c0.054-0.128,0.088-0.26,0.108-0.394c0.006-0.039,0.007-0.077,0.011-0.116  c0.007-0.087,0.008-0.174,0.002-0.26c-0.003-0.046-0.007-0.091-0.014-0.137c-0.014-0.089-0.036-0.176-0.063-0.262  c-0.012-0.034-0.019-0.069-0.031-0.103c-0.047-0.118-0.106-0.229-0.178-0.335c-0.004-0.006-0.006-0.012-0.01-0.018L67.999,3.358  c-0.01-0.013-0.003-0.026-0.013-0.04L68,3.315V4c0,0-0.033,0-0.037,0c-0.403-1-1.094-1.124-1.752-0.976  c0,0.004-0.004-0.012-0.007-0.012C66.201,3.016,66.194,3,66.194,3H66.19h-0.003h-0.003h-0.004h-0.003c0,0-0.004,0-0.007,0  s-0.003-0.151-0.007-0.151L20.495,15.227c-0.025,0.007-0.046-0.019-0.071-0.011c-0.087,0.028-0.172,0.041-0.253,0.083  c-0.054,0.027-0.102,0.053-0.152,0.085c-0.051,0.033-0.101,0.061-0.147,0.099c-0.044,0.036-0.084,0.073-0.124,0.113  c-0.048,0.048-0.093,0.098-0.136,0.152c-0.03,0.039-0.059,0.076-0.085,0.117c-0.046,0.07-0.084,0.145-0.12,0.223  c-0.011,0.023-0.027,0.042-0.036,0.066L2.911,57.664C2.891,57.715,3,57.768,3,57.82v0.002c0,0.186,0,0.375,0,0.562  c0,0.004,0,0.004,0,0.008c0,0,0,0,0,0.002c0,0,0,0,0,0.004v0.004v0.002c0,0.074-0.002,0.15,0.012,0.223  C3.015,58.631,3,58.631,3,58.633c0,0.004,0,0.004,0,0.008c0,0,0,0,0,0.002c0,0,0,0,0,0.004v0.004c0,0,0,0,0,0.002v0.004  c0,0.191-0.046,0.377,0.06,0.545c0-0.002-0.03,0.004-0.03,0.004c0,0.004-0.03,0.004-0.03,0.004c0,0.002,0,0.002,0,0.002  l-0.045,0.004c0.03,0.047,0.036,0.09,0.068,0.133l29.049,37.359c0.002,0.004,0,0.006,0.002,0.01c0.002,0.002,0,0.004,0.002,0.008  c0.006,0.008,0.014,0.014,0.021,0.021c0.024,0.029,0.052,0.051,0.078,0.078c0.027,0.029,0.053,0.057,0.082,0.082  c0.03,0.027,0.055,0.062,0.086,0.088c0.026,0.02,0.057,0.033,0.084,0.053c0.04,0.027,0.081,0.053,0.123,0.076  c0.005,0.004,0.01,0.008,0.016,0.01c0.087,0.051,0.176,0.09,0.269,0.123c0.042,0.014,0.082,0.031,0.125,0.043  c0.021,0.006,0.041,0.018,0.062,0.021c0.123,0.027,0.249,0.043,0.375,0.043c0.099,0,0.202-0.012,0.304-0.027l45.669-8.303  c0.057-0.01,0.108-0.021,0.163-0.037C79.547,88.992,79.562,89,79.575,89c0.004,0,0.004,0,0.004,0c0.021,0,0.039-0.027,0.06-0.035  c0.041-0.014,0.08-0.034,0.12-0.052c0.021-0.01,0.044-0.019,0.064-0.03c0.017-0.01,0.026-0.015,0.033-0.017  c0.014-0.008,0.023-0.021,0.037-0.028c0.14-0.078,0.269-0.174,0.38-0.285c0.014-0.016,0.024-0.034,0.038-0.048  c0.109-0.119,0.201-0.252,0.271-0.398c0.006-0.01,0.016-0.018,0.021-0.029c0.004-0.008,0.008-0.017,0.011-0.026  c0.002-0.004,0.003-0.006,0.005-0.01C80.627,88.021,80.635,88.002,80.644,87.982z M77.611,84.461L48.805,66.453l32.407-25.202  L77.611,84.461z M46.817,63.709L35.863,23.542l43.818,14.608L46.817,63.709z M84.668,40.542l8.926,5.952l-11.902,29.75  L84.668,40.542z M89.128,39.446L84.53,36.38l-6.129-12.257L89.128,39.446z M79.876,34.645L37.807,20.622L65.854,6.599L79.876,34.645  z M33.268,19.107l-6.485-2.162l23.781-6.487L33.268,19.107z M21.92,18.895l8.67,2.891L10.357,47.798L21.92,18.895z M32.652,24.649  l10.845,39.757L7.351,57.178L32.652,24.649z M43.472,67.857L32.969,92.363L8.462,60.855L43.472,67.857z M46.631,69.09l27.826,17.393  l-38.263,6.959L46.631,69.09z" data-reactid=".0.0.0.0.0.0"></path>
        </svg>
      </div>
      <div><b>Speed</b> 30ft.</div>
      <div><b>Initiative</b> <span class="js-initiative"></span></div>
    </div>
  </div>
  <div class="name">Attributes</div>
  <table>
    <tr>
      <th></th>
      <th>STR</th>
      <th>DEX</th>
      <th>CON</th>
      <th>INT</th>
      <th>WIS</th>
      <th>CHA</th>
    </tr>
    <tr>
      <td><b>Base</b></td>
      <td><span class="js-str-base"></span></td>
      <td><span class="js-dex-base"></span></td>
      <td><span class="js-con-base"></span></td>
      <td><span class="js-int-base"></span></td>
      <td><span class="js-wis-base"></span></td>
      <td><span class="js-cha-base"></span></td>
    </tr>
    <tr>
      <td><b>Mod</b></td>
      <td>(<span class="js-str-mod"></span>)</td>
      <td>(<span class="js-dex-mod"></span>)</td>
      <td>(<span class="js-con-mod"></span>)</td>
      <td>(<span class="js-int-mod"></span>)</td>
      <td>(<span class="js-wis-mod"></span>)</td>
      <td>(<span class="js-cha-mod"></span>)</td>
    </tr>
    <tr>
      <td><b>DC</b></td>
      <td><span class="js-str-dc"></span></td>
      <td><span class="js-dex-dc"></span></td>
      <td><span class="js-con-dc"></span></td>
      <td><span class="js-int-dc"></span></td>
      <td><span class="js-wis-dc"></span></td>
      <td><span class="js-cha-dc"></span></td>
    </tr>
    <tr>
      <td><b>Save</b></td>
      <td><span class="js-str-save"></span></td>
      <td><span class="js-dex-save"></span></td>
      <td><span class="js-con-save"></span></td>
      <td><span class="js-int-save"></span></td>
      <td><span class="js-wis-save"></span></td>
      <td><span class="js-cha-save"></span></td>
    </tr>
  </table>
  <div class="js-skills name">Skills &#9662;</div>
  <div class="js-skills-list skills">
    <div class="two-column">
      <div><b>Acrobatics</b> <span class="js-acrobatics"></span></div>
      <div><b>Animal Handling</b> <span class="js-animal-handling"></span></div>
      <div><b>Arcana</b> <span class="js-arcana"></span></div>
      <div><b>Athletics</b> <span class="js-athletics"></span></div>
      <div><b>Deception</b> <span class="js-deception"></span></div>
      <div><b>History</b> <span class="js-history"></span></div>
      <div><b>Insight</b> <span class="js-insight"></span></div>
      <div><b>Intimidation</b> <span class="js-intimidation"></span></div>
      <div><b>Investigation</b> <span class="js-investigation"></span></div>
    </div>
    <div class="two-column">
      <div><b>Medicine</b> <span class="js-medicine"></span></div>
      <div><b>Nature</b> <span class="js-nature"></span></div>
      <div><b>Perception</b> <span class="js-perception"></span></div>
      <div><b>Performance</b> <span class="js-performance"></span></div>
      <div><b>Persuasion</b> <span class="js-persuasion"></span></div>
      <div><b>Religion</b> <span class="js-religion"></span></div>
      <div><b>Sleight of Hand</b> <span class="js-sleight-of-hand"></span></div>
      <div><b>Stealth</b> <span class="js-stealth"></span></div>
      <div><b>Survival</b> <span class="js-survival"></span></div>
    </div>
  </div>
  <div class="actions">
    <div class="js-actions name">Actions &#9662;</div>
    <div class="js-actions-list">
      <div><b><i>Attack</i></b> <i>Melee Weapon attack:</i> (+<span class="js-attack-to-hit"></span>) to hit.</div>
      <div><i>Hit:</i> (<span class="js-attack-damage-die"></span> +<span class="js-attack-damage-mod"></span>) damage.</div>
      <div><b><i>Multiattack</i></b> <span class="js-multiattack"></span></div>
      <div><i>Hit:</i> (<span class="js-multiattack-damage-die"></span> +<span class="js-multiattack-damage-mod"></span>) damage.</div>
      <div class="js-spellcasting">
        <div><b><i>Spellcasting</i></b> <i>Spell attack:</i> (+<span class="js-spell-to-hit"></span>) to hit.</div>
        <table class="spellcasting">
          <tr>
            <th>Cantrips</th>
            <th>1st</th>
            <th>2nd</th>
            <th>3rd</th>
            <th>4th</th>
            <th>5th</th>
            <th>6th</th>
            <th>7th</th>
            <th>8th</th>
            <th>9th</th>
          </tr>
          <tr>
            <td>At will</td>
            <td><span class="js-1-slot">&mdash;</span></td>
            <td><span class="js-2-slot">&mdash;</span></td>
            <td><span class="js-3-slot">&mdash;</span></td>
            <td><span class="js-4-slot">&mdash;</span></td>
            <td><span class="js-5-slot">&mdash;</span></td>
            <td><span class="js-6-slot">&mdash;</span></td>
            <td><span class="js-7-slot">&mdash;</span></td>
            <td><span class="js-8-slot">&mdash;</span></td>
            <td><span class="js-9-slot">&mdash;</span></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  <div class="reactions">
    <div class="js-reactions name">Reactions &#9662;</div>
    <div class="js-reactions-list"></div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function() {
    $('#encounters').sortable()
    $('#encounters').disableSelection()

    $('.js-players').on('change', encounter)
    $('.js-level').on('change', encounter)
    $('.js-boss').on('change', bossEncounter)
  })

  function encounter() {
    var players = parseInt($('.js-players').val())
    var level = parseInt($('.js-level').val())

    if(parseInt(players, 10) && parseInt(level, 10)) {
      clearEncounters()
      var numberOfEnemies = calculateNumberOfEnemies(players)

      do {
        var sizeOfGroup = d(4) + 1
        $('#encounters').append(generateEncounterGroup(sizeOfGroup, selectArchetype(), level))

        numberOfEnemies -= sizeOfGroup
      }
      while(numberOfEnemies >= 5)
      $('#encounters').append(generateEncounterGroup(numberOfEnemies, selectArchetype(), level))
    }

    sortEncounters()
  }

  function bossEncounter() {
    var level = parseInt($('.js-level').val())
    var archetype = $('.js-boss').val()

    $('.js-boss-encounter').remove()

    if(parseInt(level, 10) && archetype !== 'None') {
      boss = generateEncounterGroup(1, selectArchetype(archetype), Math.min(20, level + 3))
      boss.find('.js-name').text(boss.find('.js-name').text().replace('(1)', '(BOSS)'))
      boss.removeClass('js-encounter-group')
      boss.addClass('js-boss-encounter')
      $('#encounters').prepend(boss)
    }
  }

  function d(sides) {
    return Math.floor(Math.random() * sides) + 1
  }

  function clearEncounters() {
    $('.js-encounter-group').remove()
  }

  function calculateNumberOfEnemies(numberOfPlayers) {
    return numberOfPlayers + d(Math.min(numberOfPlayers, 2))
  }

  function sortEncounters() {
    encountersContainer = $('#encounters')
    encounters = encountersContainer.children('.js-encounter-group')

    encounters.sort(function(a, b) {
      var an = parseInt($(a).find('.js-initiative').text(), 10)
      var bn = parseInt($(b).find('.js-initiative').text(), 10)
      if(an > bn) {
        return -1;
      }
      if(an < bn) {
        return 1;
      }
      return 0;
    })

    encounters.detach().appendTo(encountersContainer)
  }

  function selectArchetype(archetypeIdentifier) {
    var archetypes = [
      {
        role: 'Heavy'
        ,hitDie: 12
        ,ac: function(dexModifier) { return 14 + d(6) }
        ,abilityWeighting: ['str', 'con']
        ,skillProficiencies: [ 'athletics', 'intimidation', 'perception', 'survival', 'medicine', 'history' ]
        ,spellcasting: false
        ,reactions: [
          {
            name: 'Parry'
            ,description: function(proficiencyBonus) { return 'Add +' + proficiencyBonus + ' to AC against one melee attack that would hit it.' }
          }
          ,{
            name: 'Shield'
            ,description: function(proficiencyBonus) { return 'When a creature makes an attack against an ally wihtin 5 feet that would hit, add +2 to their AC' }
          }
          ,{
            name: 'Redirect Attack'
            ,description: function(proficiencyBonus) { return 'Choose an ally within 5 feet and swap places. The chosen ally becomes the target instead.' }
          }
        ]
      }
      ,{
        role: 'Light'
        ,hitDie: 10
        ,ac: function(dexModifier) { return (11 + d(4) + Math.min(2, dexModifier)) }
        ,abilityWeighting: ['dex', 'con']
        ,skillProficiencies: [ 'acrobatics', 'stealth', 'sleight-of-hand', 'investigation', 'perception', 'deception' ]
        ,spellcasting: false
        ,reactions: [
          {
            name: 'Parry'
            ,description: function(proficiencyBonus) { return 'Add +' + proficiencyBonus + ' to AC against one melee attack that would hit it.' }
          }
          ,{
            name: 'Shield'
            ,description: function(proficiencyBonus) { return 'When a creature makes an attack against an ally wihtin 5 feet that would hit, add +2 to their AC' }
          }
          ,{
            name: 'Redirect Attack'
            ,description: function(proficiencyBonus) { return 'Choose an ally within 5 feet and swap places. The chosen ally becomes the target instead.' }
          }
        ]
      }
      ,{
        role: 'Ranged'
        ,hitDie: 8
        ,ac: function(dexModifier) { return (11 + d(4) + Math.min(2, dexModifier)) }
        ,abilityWeighting: ['dex', 'wis']
        ,skillProficiencies: [ 'acrobatics', 'stealth', 'nature', 'perception', 'survival', 'animal-handling' ]
        ,spellcasting: false
        ,reactions: []
      }
      ,{
        role: 'Arcane Caster'
        ,hitDie: 6
        ,ac: function(dexModifier) { return 10 + dexModifier }
        ,abilityWeighting: ['int', 'cha']
        ,skillProficiencies: [ 'arcana', 'history', 'investigation', 'deception', 'persuasion' ,'sleight-of-hand' ]
        ,spellcasting: true
        ,school: [
          {
            name: 'Mage'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Fire Bolt', 'Light', 'Mage Hand', 'Prestidigitation']
              }
              ,{
                level: '1st level'
                ,spells: ['Detect Magic', 'Mage Armor', 'Magic Missile', 'Shield']
              }
              ,{
                level: '2nd level'
                ,spells: ['Misty Step', 'Suggestion']
              }
              ,{
                level: '3rd level'
                ,spells: ['Counterspell', 'Fireball', 'Fly']
              }
              ,{
                level: '4th level'
                ,spells: ['Greater Invisibility', 'Ice Storm']
              }
              ,{
                level: '5th level'
                ,spells: ['Cone Of Cold']
              }
            ]
          }
          ,{
            name: 'Archmage'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Fire Bolt', 'Light', 'Mage Hand', 'Prestidigitation', 'Shocking Grasp']
              }
              ,{
                level: '1st level'
                ,spells: ['Detect Magic', 'Identify', 'Mage Armor', 'Magic Missile']
              }
              ,{
                level: '2nd level'
                ,spells: ['Detect Thoughts', 'Mirror Image', 'Misty Step']
              }
              ,{
                level: '3rd level'
                ,spells: ['Counterspell', 'Fly', 'Lightning Bolt']
              }
              ,{
                level: '4th level'
                ,spells: ['Banishment', 'Fire Shield', 'Stoneskin']
              }
              ,{
                level: '5th level'
                ,spells: ['Cone Of Cold', 'Scrying', 'Wall Of Force']
              }
              ,{
                level: '6th level'
                ,spells: ['Globe Of Invulnerability']
              }
              ,{
                level: '7th level'
                ,spells: ['Teleport']
              }
              ,{
                level: '8th level'
                ,spells: ['Mind Blank']
              }
              ,{
                level: '9th level'
                ,spells: ['Time Stop']
              }
            ]
          }
          ,{
            name: 'Abjurer'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Blade Ward', 'Dancing Lights', 'Mending', 'Message', 'Ray Of Frost']
              }
              ,{
                level: '1st level'
                ,spells: ['Alarm', 'Mage Armor', 'Magic Missile', 'Shield']
              }
              ,{
                level: '2nd level'
                ,spells: ['Arcane Lock', 'Invisibility']
              }
              ,{
                level: '3rd level'
                ,spells: ['Counterspell', 'Dispel Magic', 'Fireball']
              }
              ,{
                level: '4th level'
                ,spells: ['Banishment', 'Stoneskin']
              }
              ,{
                level: '5th level'
                ,spells: ['Cone Of Cold', 'Wall Of Force']
              }
              ,{
                level: '6th level'
                ,spells: ['Flesh To Stone', 'Globe Of Invulnerability']
              }
              ,{
                level: '7th level'
                ,spells: ['Symbol', 'Teleport']
              }
            ]
          }
          ,{
            name: 'Apprentice Wizard'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Fire Bolt', 'Mending', 'Prestidigitation']
              }
              ,{
                level: '1st level'
                ,spells: ['Burning Hands', 'Disguise Self', 'Shield']
              }
            ]
          }
          ,{
            name: 'Bard'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Friends', 'Mage Hand', 'Vicious Mockery']
              }
              ,{
                level: '1st level'
                ,spells: ['Charm Person', 'Healing Word', 'Heroism', 'Sleep', 'Thunderwave']
              }
              ,{
                level: '2nd level'
                ,spells: ['Invisibility', 'Shatter']
              }
            ]
          }
          ,{
            name: 'Conjurer'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Acid Splash', 'Mage Hand', 'Poison Spray', 'Prestidigitation']
              }
              ,{
                level: '1st level'
                ,spells: ['Mage Armor', 'Magic Missile', 'Unseen Servant']
              }
              ,{
                level: '2nd level'
                ,spells: ['Cloud Of Daggers', 'Misty Step', 'Web']
              }
              ,{
                level: '3rd level'
                ,spells: ['Fireball', 'Stinking Cloud']
              }
              ,{
                level: '4th level'
                ,spells: ['Evards Black Tentacles', 'Stoneskin']
              }
              ,{
                level: '5th level'
                ,spells: ['Cloudkill', 'Conjure Elemental']
              }
            ]
          }
          ,{
            name: 'Diviner'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Fire Bolt', 'Light', 'Mage Hand', 'Message', 'True Strike']
              }
              ,{
                level: '1st level'
                ,spells: ['Detect Magic', 'Feather Fall', 'Mage Armor']
              }
              ,{
                level: '2nd level'
                ,spells: ['Detect Thoughts', 'Locate Object', 'Scorching Ray']
              }
              ,{
                level: '3rd level'
                ,spells: ['Clairvoyance', 'Fly', 'Fireball']
              }
              ,{
                level: '4th level'
                ,spells: ['Acane Eye', 'Ice Storm', 'Stoneskin']
              }
              ,{
                level: '5th level'
                ,spells: ['Rarys Telepathic Bond', 'Scrying']
              }
              ,{
                level: '6th level'
                ,spells: ['Mass Suggestion', 'True Seeing']
              }
              ,{
                level: '7th level'
                ,spells: ['Delayed Blast Fireball', 'Teleport']
              }
              ,{
                level: '8th level'
                ,spells: ['Maze']
              }
            ]
          }
          ,{
            name: 'Enchanter'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Friends', 'Mage Hand', 'Mending', 'Message']
              }
              ,{
                level: '1st level'
                ,spells: ['Charm Person', 'Mage Armor', 'Magic Missile']
              }
              ,{
                level: '2nd level'
                ,spells: ['Hold Person', 'Invisibility', 'Suggestion']
              }
              ,{
                level: '3rd level'
                ,spells: ['Fireball', 'Haste', 'Tongues']
              }
              ,{
                level: '4th level'
                ,spells: ['Dominate Beast', 'Stoneskin']
              }
              ,{
                level: '5th level'
                ,spells: ['Dominate Monster']
              }
            ]
          }
          ,{
            name: 'Evoker'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Fire Bolt', 'Light', 'Prestidigitation', 'Ray Of Frost']
              }
              ,{
                level: '1st level'
                ,spells: ['Burning Hands', 'Mage Armor', 'Magic Missile']
              }
              ,{
                level: '2nd level'
                ,spells: ['Mirror Image', 'Misty Step', 'Shatter']
              }
              ,{
                level: '3rd level'
                ,spells: ['Counterspell', 'Fireball', 'Lightning Bolt']
              }
              ,{
                level: '5th level'
                ,spells: ['Ice Storm', 'Stoneskin']
              }
              ,{
                level: '6th level'
                ,spells: ['Bigbys Hand', 'Cone Of Cold']
              }
              ,{
                level: '7th level'
                ,spells: ['Chain Lightning', 'Wall Of Ice']
              }
            ]
          }
          ,{
            name: 'Illusionist'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Dancing Lights', 'Mage Hand', 'Minor Illusion', 'Poison Spray']
              }
              ,{
                level: '1st level'
                ,spells: ['Color Spray', 'Disguise Self', 'Mage Armor', 'Magic Missile']
              }
              ,{
                level: '2nd level'
                ,spells: ['Invisibility', 'Mirror Image', 'Phantasmal Force']
              }
              ,{
                level: '3rd level'
                ,spells: ['Major Image', 'Phantom Steed']
              }
              ,{
                level: '4th level'
                ,spells: ['Phantasmal Killer']
              }
            ]
          }
          ,{
            name: 'Necromancer'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Chill Touch', 'Dancing Lights', 'Mage Hand', 'Mending']
              }
              ,{
                level: '1st level'
                ,spells: ['False Life', 'Mage Armor', 'Ray Of Sickness']
              }
              ,{
                level: '2nd level'
                ,spells: ['Blindness/Deafness', 'Ray Of Enfeeblement', 'Web']
              }
              ,{
                level: '3rd level'
                ,spells: ['Animate Dead', 'Bestow Curse', 'Vampiric Touch']
              }
              ,{
                level: '4th level'
                ,spells: ['Blight', 'Dimension Door', 'Stoneskin']
              }
              ,{
                level: '5th level'
                ,spells: ['Bigbys Hand', 'Cloudkill']
              }
              ,{
                level: '6th level'
                ,spells: ['Circle Of Death']
              }
            ]
          }
          ,{
            name: 'Transmuter'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Light', 'Mending', 'Prestidigitation', 'Ray Of Frost']
              }
              ,{
                level: '1st level'
                ,spells: ['Chromatic Orb', 'Expeditious Retreat', 'Mage Armor']
              }
              ,{
                level: '2nd level'
                ,spells: ['Alter Self', 'Hold Person', 'Knock']
              }
              ,{
                level: '3rd level'
                ,spells: ['Blink', 'Fireball', 'Slow']
              }
              ,{
                level: '4th level'
                ,spells: ['Polymorph', 'Stoneskin']
              }
              ,{
                level: '5th level'
                ,spells: ['Telekinesis']
              }
            ]
          }
        ]
        ,reactions: [
          {
            name: 'Counterspell'
            ,description: function(proficiencyBonus) { return '(3rd Level) If the creature is casting a spell of 3rd level or lower, its spell fails and has no effect. If it is casting a spell of 4th level or higher, make an ability check using your spellcasting ability. The DC equals 10 + the spell’s level. On a success, the creature’s spell fails and has no effect.' }
          }
          ,{
            name: 'Feather Fall'
            ,description: function(proficiencyBonus) { return '(1st Level) Choose up to five falling creatures within range. A falling creature’s rate of descent slows to 60 feet per round until the spell ends. If the creature lands before the spell ends, it takes no falling damage and can land on its feet, and the spell ends for that creature.' }
          }
          ,{
            name: 'Hellish Rebuke'
            ,description: function(proficiencyBonus) { return '(1st Level) The creature must make a Dexterity saving throw. It takes 2d10 fire damage on a failed save, or half as much damage on a successful one.' }
          }
          ,{
            name: 'Shield'
            ,description: function(proficiencyBonus) { return '(1st Level) Until the start of your next turn, you have a +5 bonus to AC, including against the triggering attack, and you take no damage from magic missile.' }
          }
        ]
      }
      ,{
        role: 'Divine Caster'
        ,hitDie: 8
        ,ac: function(dexModifier) { return 13 + d(6) }
        ,abilityWeighting: ['str', 'wis']
        ,skillProficiencies: [ 'athletics', 'insight', 'perception', 'medicine', 'religion', 'persuasion' ]
        ,spellcasting: true
        ,school: [
          {
            name: 'Priest'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Light', 'Sacred Flame', 'Thaumaturgy']
              }
              ,{
                level: '1st level'
                ,spells: ['Cure Wounds', 'Guiding Bolt', 'Sanctuary']
              }
              ,{
                level: '2nd level'
                ,spells: ['Lesser Restoration', 'Spiritual Weapon']
              }
              ,{
                level: '3rd level'
                ,spells: ['Dispel Magic', 'Spirit Guardians']
              }
            ]
          }
          ,{
            name: 'Druid'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Druidcraft', 'Produce Flame', 'Shillelagh']
              }
              ,{
                level: '1st level'
                ,spells: ['Entangle', 'Longstrider', 'Speak With Animals', 'Thunderwave']
              }
              ,{
                level: '2nd level'
                ,spells: ['Animal Messenger', 'Barkskin']
              }
            ]
          }
          ,{
            name: 'Cultist'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Light', 'Sacredflame', 'Thaumaturgy']
              }
              ,{
                level: '1st level'
                ,spells: ['Command', 'Inflict Wounds', 'Shield Of Faith']
              }
              ,{
                level: '2nd level'
                ,spells: ['Hold Person', 'Spiritual Weapon']
              }
            ]
          }
          ,{
            name: 'Archdruid'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Druidcraft', 'Mending', 'Poison Spray', 'Produce Flame']
              }
              ,{
                level: '1st level'
                ,spells: ['Cure Wounds', 'Entangle', 'Faerie Fire', 'Speak With Animals']
              }
              ,{
                level: '2nd level'
                ,spells: ['Animal Messenger', 'Beast Sense', 'Hold Person']
              }
              ,{
                level: '3rd level'
                ,spells: ['Conjure Animals', 'Meld Into Stone', 'Water Breathing']
              }
              ,{
                level: '4th level'
                ,spells: ['Dominate Beast', 'Locate Creature', 'Stoneskin', 'Wall Of Fire']
              }
              ,{
                level: '5th level'
                ,spells: ['Commune With Nature', 'Mass Cure Wounds', 'Tree Stride']
              }
              ,{
                level: '6th level'
                ,spells: ['Heal', 'Heroes Feast', 'Sunbeam']
              }
              ,{
                level: '7th level'
                ,spells: ['Firestorm']
              }
              ,{
                level: '8th level'
                ,spells: ['Animal Shapes']
              }
              ,{
                level: '9th level'
                ,spells: ['Foresight']
              }
            ]
          }
          ,{
            name: 'Blackguard'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Command', 'Protection From Evil And Good', 'Thunderous Smite']
              }
              ,{
                level: '1st level'
                ,spells: ['Branding Smite', 'Find Stead']
              }
              ,{
                level: '2nd level'
                ,spells: ['Binding Smite', 'Dispel Magic']
              }
            ]
          }
          ,{
            name: 'War Priest'
            ,spells: [
              {
                level: 'Cantrips'
                ,spells: ['Light', 'Mending', 'Sacred Flame', 'Spare The Dying']
              }
              ,{
                level: '1st level'
                ,spells: ['Divine Favor', 'Guiding Bolt', 'Healing Word', 'Shield Of Faith']
              }
              ,{
                level: '2nd level'
                ,spells: ['Lesser Restoration', 'Magic Weapon', 'Prayer Of Healing', 'Silence', 'Spiritual Weapon']
              }
              ,{
                level: '3rd level'
                ,spells: ['Beacon Of Hope', 'Crusaders Mantle', 'Dispel Magic', 'Revivify', 'Spirit Guardians', 'Water Walk']
              }
              ,{
                level: '4th level'
                ,spells: ['Banishment', 'Freedom Of Movement', 'Guardian Of Faith', 'Stoneskin']
              }
              ,{
                level: '5th level'
                ,spells: ['Flame Strike', 'Mass Cure Wounds', 'Hold Monster']
              }
            ]
          }
        ]
        ,reactions: [
          {
            name: 'Parry'
            ,description: function(proficiencyBonus) { return 'Add +' + proficiencyBonus + ' to AC against one melee attack that would hit it.' }
          }
          ,{
            name: 'Shield'
            ,description: function(proficiencyBonus) { return 'When a creature makes an attack against an ally wihtin 5 feet that would hit, add +2 to their AC' }
          }
        ]
      }
    ]

    for(i = 0; i < archetypes.length; i++) {
      if(archetypes[i].role == archetypeIdentifier) {
        return archetypes[i]
      }
    }
    return archetypes[d(archetypes.length) - 1]
  }

  function isProficientWithAttribute(archetype, ability) {
    return (archetype.abilityWeighting.indexOf(ability) != -1)
  }

  function isProficientWithSkill(archetype, skill) {
    return (archetype.skillProficiencies.indexOf(skill) != -1)
  }

  function calculateAttributes(averagePartyLevel) {
    var baseAttributes = [ 15, 14, 13, 12, 10, 8 ]
    var additionalAttributes = 4 + 2 * Math.floor(averagePartyLevel / 4)
    for(i = 0; i < additionalAttributes; i++) {
      baseAttributes[d(6) - 1] += 1
    }

    return baseAttributes
  }

  function calculateAttributeModifier(attribute) {
    return Math.floor(attribute/2 - 5)
  }

  function calculateDC(abilityModifier, proficiencyBonus, isProficientWithAttribute) {
    return 10 + abilityModifier + (isProficientWithAttribute ? proficiencyBonus : 0)
  }

  function calculateSaveModifier(abilityModifier, proficiencyBonus, isProficientWithAttribute) {
    return abilityModifier + (isProficientWithAttribute ? proficiencyBonus : 0)
  }

  function calculateSkillModifier(abilityModifier, proficiencyBonus, isProficientWithSkill) {
    return abilityModifier + (isProficientWithSkill ? proficiencyBonus : 0)
  }

  function calculateProficiencyBonus(averagePartyLevel) {
    return 1 + Math.ceil(averagePartyLevel/4)
  }

  function calculateHitPoints(hitDie, conModifier, averagePartyLevel) {
    return hitDie + conModifier + (averagePartyLevel - 1) * (Math.floor(hitDie/2) + 1 + conModifier)
  }

  function calculateSpellSlots(averagePartyLevel) {
    var spellSlots = [
       [2]
      ,[3]
      ,[4,2]
      ,[4,3]
      ,[4,3,2]
      ,[4,3,3]
      ,[4,3,3,1]
      ,[4,3,3,2]
      ,[4,3,3,3,1]
      ,[4,3,3,3,2]
      ,[4,3,3,3,2,1]
      ,[4,3,3,3,2,1]
      ,[4,3,3,3,2,1,1]
      ,[4,3,3,3,2,1,1]
      ,[4,3,3,3,2,1,1,1]
      ,[4,3,3,3,2,1,1,1]
      ,[4,3,3,3,2,1,1,1,1]
      ,[4,3,3,3,3,1,1,1,1]
      ,[4,3,3,3,3,2,1,1,1]
      ,[4,3,3,3,3,2,2,1,1]
    ]

    return spellSlots[averagePartyLevel - 1]
  }

  function calculateBeastialLikelihood(archetype) {
    if(archetype.role == 'Heavy' || archetype.role == 'Light') {
      return (d(4) === 1)
    }
    else {
      return false
    }
  }

  function generateEncounterGroup(sizeOfGroup, archetype, averagePartyLevel) {
    if(sizeOfGroup < 1) {
      return
    }

    var template = $('#template').clone()
    template.attr('id', '')
    template.attr('data-id', generateUuid())
    template.addClass('js-encounter-group')

    var beastial = calculateBeastialLikelihood(archetype)
    var baseAttributes = calculateAttributes(averagePartyLevel)
    var proficiencyBonus = calculateProficiencyBonus(averagePartyLevel)

    var abilityModifiers = fillInAbilityTable(template, baseAttributes, beastial, proficiencyBonus, archetype)
    fillInSkillTable(template, abilityModifiers, proficiencyBonus, archetype)

    template.find('.js-name').text((beastial ? 'Beastial ' : '') + archetype.role + ' (' + sizeOfGroup + ')')
    template.find('.js-level').text(averagePartyLevel)
    template.find('.js-ac').text(archetype.ac(abilityModifiers.dex))
    template.find('.js-hp').text(calculateHitPoints(archetype.hitDie, abilityModifiers.con, averagePartyLevel))
    template.find('.js-initiative').text(abilityModifiers.dex + d(20))

    template.find('.js-attack-to-hit').text(Math.max(abilityModifiers.str, abilityModifiers.dex) + proficiencyBonus + d(2))
    template.find('.js-attack-damage-die').text(Math.ceil(proficiencyBonus/2) + 'd' + (archetype.hitDie - 2))
    template.find('.js-attack-damage-mod').text(Math.max(abilityModifiers.str, abilityModifiers.dex) + d(2))
    template.find('.js-multiattack').text(proficiencyBonus)
    template.find('.js-multiattack-damage-die').text(Math.floor(proficiencyBonus/3) + 'd' + (archetype.hitDie - 4))
    template.find('.js-multiattack-damage-mod').text(Math.max(abilityModifiers.str, abilityModifiers.dex))
    if(!archetype.spellcasting) {
      template.find('.js-spellcasting').hide()
    }
    else {
      var spellSlots = calculateSpellSlots(averagePartyLevel)
      for(i=0; i < spellSlots.length; i++) {
        template.find('.js-' + (i+1) + '-slot').text(spellSlots[i])
      }
      if(archetype.role == 'Divine Caster') {
        template.find('.js-spell-to-hit').text(abilityModifiers.wis + proficiencyBonus + d(2))
      }
      else {
        template.find('.js-spell-to-hit').text(Math.max(abilityModifiers.int, abilityModifiers.cha) + proficiencyBonus + d(2))
      }
      fillInCasterSchool(template, archetype)
    }

    if(!beastial) {
      fillInReaction(template, archetype, proficiencyBonus)
      template.find('.js-reactions').on('click', function() { template.find('.js-reactions-list').toggle() })
      template.find('.js-reactions')
    }

    template.find('.js-skills').on('click', function() { template.find('.js-skills-list').toggle() })
    template.find('.js-actions').on('click', function() { template.find('.js-actions-list').toggle() })

    template.find('.js-reroll').on('click', function() { reroll(template.attr('data-id'), sizeOfGroup, averagePartyLevel) })
    return template
  }

  function fillInAbilityTable(encounterGroup, baseAttributes, beastial, proficiencyBonus, archetype) {
    var modifiers = distributeAttributes(encounterGroup, baseAttributes, archetype, beastial)

    var attributes = [ 'str', 'dex', 'con', 'int', 'wis', 'cha' ]
    for(i = 0; i < attributes.length; i++) {
      var attribute = attributes[i]
      var modifier = modifiers[attribute]
      var plusSymbol = (modifier < 0 ? '' : '+')

      encounterGroup.find('.js-' + attribute + '-mod').text(plusSymbol + modifier)
      encounterGroup.find('.js-' + attribute + '-dc').text(calculateDC(modifier, proficiencyBonus, isProficientWithAttribute(archetype, attribute)))
      encounterGroup.find('.js-' + attribute + '-save').text(plusSymbol + calculateSaveModifier(modifier, proficiencyBonus, isProficientWithAttribute(archetype, attribute)))
    }

    return modifiers
  }

  function distributeAttributes(encounterGroup, baseAttributes, archetype, beastial) {
    var abilityModifiers = { }
    var dumpAbilities = [ 'str', 'dex', 'con', 'int', 'wis', 'cha' ]

    for(i = 0; i < archetype.abilityWeighting.length; i++) {
      var prioritizedAttribute = archetype.abilityWeighting[i]
      var prioritizedAttributeIndex = dumpAbilities.indexOf(prioritizedAttribute)
      dumpAbilities.splice(prioritizedAttributeIndex, 1)

      var largestAbility = Math.max.apply(Math,baseAttributes)
      var largestAbilityIndex = baseAttributes.indexOf(largestAbility)
      var ability = baseAttributes.splice(largestAbilityIndex, 1)

      encounterGroup.find('.js-' + prioritizedAttribute + '-base').text(ability)
      abilityModifiers[prioritizedAttribute] = calculateAttributeModifier(ability)
    }

    for(i = 0; i < dumpAbilities.length; i++) {
      var randomAbility = dumpAbilities[i]
      var randomAbilityIndex = d(baseAttributes.length) - 1
      var ability = baseAttributes.splice(randomAbilityIndex, 1)
      encounterGroup.find('.js-' + randomAbility + '-base').text(ability)
      abilityModifiers[randomAbility] = calculateAttributeModifier(ability)
    }

    if(beastial) {
      var int = d(6)
      encounterGroup.find('.js-int-base').text(int)
      abilityModifiers['int'] = calculateAttributeModifier(int)

      var cha = d(6) +  d(6)
      encounterGroup.find('.js-cha-base').text(cha)
      abilityModifiers['cha'] = calculateAttributeModifier(cha)
    }

    return abilityModifiers
  }

  function fillInSkillTable(encounterGroup, modifiers, proficiencyBonus, archetype) {
    encounterGroup.find('.js-acrobatics').text(calculateSkillModifier(modifiers.dex, proficiencyBonus, isProficientWithSkill(archetype, 'acrobatics')))
    encounterGroup.find('.js-animal-handling').text(calculateSkillModifier(modifiers.wis, proficiencyBonus, isProficientWithSkill(archetype, 'animal-handling')))
    encounterGroup.find('.js-arcana').text(calculateSkillModifier(modifiers.int, proficiencyBonus, isProficientWithSkill(archetype, 'arcana')))
    encounterGroup.find('.js-athletics').text(calculateSkillModifier(modifiers.str, proficiencyBonus, isProficientWithSkill(archetype, 'athletics')))
    encounterGroup.find('.js-deception').text(calculateSkillModifier(modifiers.cha, proficiencyBonus, isProficientWithSkill(archetype, 'deception')))
    encounterGroup.find('.js-history').text(calculateSkillModifier(modifiers.int, proficiencyBonus, isProficientWithSkill(archetype, 'history')))
    encounterGroup.find('.js-insight').text(calculateSkillModifier(modifiers.wis, proficiencyBonus, isProficientWithSkill(archetype, 'insight')))
    encounterGroup.find('.js-intimidation').text(calculateSkillModifier(modifiers.cha, proficiencyBonus, isProficientWithSkill(archetype, 'intimidation')))
    encounterGroup.find('.js-investigation').text(calculateSkillModifier(modifiers.int, proficiencyBonus, isProficientWithSkill(archetype, 'investigation')))
    encounterGroup.find('.js-medicine').text(calculateSkillModifier(modifiers.wis, proficiencyBonus, isProficientWithSkill(archetype, 'medicine')))
    encounterGroup.find('.js-nature').text(calculateSkillModifier(modifiers.int, proficiencyBonus, isProficientWithSkill(archetype, 'nature')))
    encounterGroup.find('.js-perception').text(calculateSkillModifier(modifiers.wis, proficiencyBonus, isProficientWithSkill(archetype, 'perception')))
    encounterGroup.find('.js-performance').text(calculateSkillModifier(modifiers.cha, proficiencyBonus, isProficientWithSkill(archetype, 'performance')))
    encounterGroup.find('.js-persuasion').text(calculateSkillModifier(modifiers.cha, proficiencyBonus, isProficientWithSkill(archetype, 'persuasion')))
    encounterGroup.find('.js-religion').text(calculateSkillModifier(modifiers.int, proficiencyBonus, isProficientWithSkill(archetype, 'religion')))
    encounterGroup.find('.js-sleight-of-hand').text(calculateSkillModifier(modifiers.dex, proficiencyBonus, isProficientWithSkill(archetype, 'sleight-of-hand')))
    encounterGroup.find('.js-stealth').text(calculateSkillModifier(modifiers.dex, proficiencyBonus, isProficientWithSkill(archetype, 'stealth')))
    encounterGroup.find('.js-survival').text(calculateSkillModifier(modifiers.wis, proficiencyBonus, isProficientWithSkill(archetype, 'survival')))
  }

  function fillInReaction(encounterGroup, archetype, proficiencyBonus) {
    if(archetype.reactions.length > 0) {
      var reaction = archetype.reactions[d(archetype.reactions.length) - 1]
      encounterGroup.find('.js-reactions-list').append(
        '<div>'+
          '<b><i>' + reaction.name + '</i></b> ' +
          reaction.description(proficiencyBonus) +
        '</div>'
      )
      encounterGroup.find('.reactions').toggle()
    }
  }

  function fillInCasterSchool(encounterGroup, archetype) {
    var school = archetype.school[d(archetype.school.length) - 1]
    encounterGroup.find('.js-name').prepend(school.name + ' ')
    for(i = 0; i < school.spells.length; i++) {
      var spells = '<div>' + school.spells[i].level + ': '
      for(j = 0; j < school.spells[i].spells.length; j++) {
        var grimoireLink = 'https://thegrimoire.xyz/spells/' +
          school.spells[i].spells[j].
            replace(' ', '-').
            replace('/', '').
            toLowerCase()
        spells += '<i>' +
          '<a target="_blank" href="' + grimoireLink + '">' +
            school.spells[i].spells[j] +
          '</a>, '
        '</i>'
      }
      spells += '</div>'
      if(i === 0 || $.isNumeric(encounterGroup.find('.js-' + i + '-slot').text())) {
        encounterGroup.find('.js-spellcasting').append(spells)
      }
    }
  }

  function reroll(encounterGroupId, sizeOfGroup, averagePartyLevel) {
    encounterGroup = $('[data-id="'+ encounterGroupId +'"')
    if(encounterGroup.find('.js-name').text().indexOf('(BOSS)') > 0) {
      bossEncounter()
    }
    else {
      encounterGroup.after(generateEncounterGroup(sizeOfGroup, selectArchetype(), averagePartyLevel))
      encounterGroup.remove()
    }
  }

  function generateUuid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {var r = Math.random()*16|0,v=c=='x'?r:r&0x3|0x8;return v.toString(16);});
  }
</script>
